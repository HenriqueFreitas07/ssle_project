<group name="local,network_dos,apache_overload,syn_flood,">
  <!-- Existing rules from your configuration -->
  <rule id="200100" level="7">
    <if_sid>530</if_sid>
    <match>established connection</match>
    <description>New network connection observed</description>
  </rule>

  <rule id="200101" level="12" frequency="200" timeframe="30">
    <if_matched_sid>200100</if_matched_sid>
    <description>High rate of new TCP/UDP connections (Possible DoS)</description>
    <group>dos,network,</group>
  </rule>

  <rule id="200110" level="5">
    <match>network_traffic</match>
    <description>Network traffic event</description>
    <group>network</group>
  </rule>

  <rule id="200111" level="10">
    <if_sid>200110</if_sid>
    <regex>rx_bytes": ([0-9]{9,})</regex>
    <description>High inbound network throughput detected (Possible overload)</description>
    <group>dos,network</group>
  </rule>

  <rule id="200120" level="6">
    <if_sid>530</if_sid>
    <match>dstport:80</match>
    <description>New connection to Apache HTTP</description>
  </rule>

  <rule id="200121" level="6">
    <if_sid>530</if_sid>
    <match>dstport:443</match>
    <description>New connection to Apache HTTPS</description>
  </rule>
  <rule id="200122" level="14" frequency="50" timeframe="20">
    <if_matched_sid>200120,200121</if_matched_sid>
    <description>High rate of inbound connections to Apache (Possible HTTP flood)</description>
    <group>dos,http_flood,apache,</group>
  </rule>
  <rule id="200130" level="8">
    <if_sid>550</if_sid>
    <match>SYN</match>
    <description>TCP SYN packet observed</description>
  </rule>

  <rule id="200131" level="15" frequency="300" timeframe="20">
    <if_matched_sid>200130</if_matched_sid>
    <description>Potential SYN flood detected</description>
    <group>dos,syn_flood,</group>
  </rule>

  
  <rule id="200140" level="10" frequency="50" timeframe="60">
    <if_matched_sid>200120,200121</if_matched_sid>
    <same_source_ip />
    <description>Same IP making repeated connections to Apache</description>
    <group>dos,apache,http_flood,</group>
  </rule>

  <rule id="200150" level="10">
    <if_sid>30301</if_sid>
    <match>error</match>
    <description>Apache error detected</description>
  </rule>

  <rule id="200151" level="13" frequency="10" timeframe="30">
    <if_matched_sid>200150</if_matched_sid>
    <description>High rate of Apache errors (Possible DoS impact)</description>
    <group>dos,apache,service_availability,</group>
  </rule>

  <rule id="200160" level="7">
    <if_sid>530</if_sid>
    <match>protocol: udp</match>
    <description>UDP connection observed</description>
  </rule>

  <rule id="200161" level="13" frequency="400" timeframe="30">
    <if_matched_sid>200160</if_matched_sid>
    <description>UDP flood detected</description>
    <group>dos,udp_flood,network,</group>
  </rule>

  <rule id="200170" level="12" frequency="100" timeframe="120">
    <if_matched_sid>200120,200121</if_matched_sid>
    <same_source_ip />
    <description>Potential slowloris attack (many slow connections from same IP)</description>
    <group>dos,slowloris,apache,</group>
  </rule>

  <!-- Detect when active response blocks an attacker -->
  <rule id="200180" level="5">
    <if_sid>651</if_sid>
    <match>firewall-drop</match>
    <description>Active response: IP blocked by firewall</description>
    <group>active_response,</group>
  </rule>

  <rule id="200181" level="3">
    <if_sid>652</if_sid>
    <match>firewall-drop</match>
    <description>Active response: IP unblocked by firewall</description>
    <group>active_response,</group>
  </rule>

  <!-- ====== SHELLSHOCK DETECTION ====== -->
  <rule id="100100" level="15">
    <if_sid>30100,30101,30102,30103,30104,30105,30106,30107,30108,30109,30110,30112,30115,30116,30117</if_sid>
    <regex type="pcre2">\(\)\s*\{\s*:;\s*\}</regex>
    <description>Shellshock attack detected in Apache logs</description>
    <mitre>
      <id>T1068</id>
    </mitre>
    <group>shellshock,exploit,apache,</group>
  </rule>

  <rule id="100101" level="15">
    <if_sid>30100,30101,30102,30103,30104,30105,30106,30107,30108,30109,30110,30112,30115,30116,30117</if_sid>
    <regex type="pcre2">\(\)\s*\{.*;\s*\}\s*;.*(/bin/(ba)?sh|wget|curl|python)</regex>
    <description>Shellshock exploitation attempt - command execution pattern</description>
    <mitre>
      <id>T1068</id>
      <id>T1059</id>
    </mitre>
    <group>shellshock,exploit,apache,</group>
  </rule>

  <rule id="100102" level="15">
    <if_sid>30100,30101,30102,30103,30104,30105,30106,30107,30108,30109,30110,30112,30115,30116,30117</if_sid>
    <match>User-Agent</match>
    <regex type="pcre2">\(\)\s*\{</regex>
    <description>Shellshock attack in User-Agent header</description>
    <mitre>
      <id>T1068</id>
    </mitre>
    <group>shellshock,exploit,apache,</group>
  </rule>

  <!-- Override default rule 31108 to enable DoS frequency detection -->
  <rule id="31108" level="3" overwrite="yes">
    <if_sid>31100</if_sid>
    <id>^2|^3</id>
    <compiled_rule>is_simple_http_request</compiled_rule>
    <description>HTTP access log - successful request</description>
    <group>web,accesslog,</group>
  </rule>

  <rule id="100200" level="10" frequency="50" timeframe="10">
    <if_matched_sid>31108</if_matched_sid>
    <same_source_ip />
    <description>HTTP flood from single IP (50 req/10s) - Possible DoS</description>
    <mitre>
      <id>T1499</id>
    </mitre>
    <group>dos,apache,http_flood,</group>
  </rule>

  <rule id="100201" level="12" frequency="100" timeframe="15">
    <if_matched_sid>31108</if_matched_sid>
    <same_source_ip />
    <description>High frequency HTTP flood (100 req/15s) - DoS confirmed</description>
    <mitre>
      <id>T1499</id>
    </mitre>
    <group>dos,apache,http_flood,</group>
  </rule>

  <rule id="100202" level="15" frequency="200" timeframe="20">
    <if_matched_sid>31108</if_matched_sid>
    <same_source_ip />
    <description>Aggressive DoS attack (200 req/20s)</description>
    <mitre>
      <id>T1499</id>
    </mitre>
    <group>dos,apache,http_flood,</group>
  </rule>

  <rule id="100203" level="12" frequency="30" timeframe="10">
    <if_matched_sid>31108</if_matched_sid>
    <same_source_ip/>
    <same_url/>
    <description>HTTP flood targeting specific endpoint (30 req/10s)</description>
    <mitre>
      <id>T1499</id>
    </mitre>
    <group>dos,apache,http_flood,</group>
  </rule>

  <rule id="100204" level="10">
    <if_sid>30301,30302</if_sid>
    <match>408|Timeout</match>
    <description>HTTP request timeout - Possible Slowloris attack</description>
    <mitre>
      <id>T1499.003</id>
    </mitre>
    <group>dos,slowloris,apache,</group>
  </rule>

  <rule id="100205" level="13" frequency="10" timeframe="60">
    <if_matched_sid>100204</if_matched_sid>
    <same_source_ip />
    <description>Multiple HTTP timeouts - Slowloris DoS detected</description>
    <mitre>
      <id>T1499.003</id>
    </mitre>
    <group>dos,slowloris,apache,</group>
  </rule>

  <rule id="100206" level="8">
    <if_sid>30100</if_sid>
    <match>POST</match>
    <regex type="pcre2">POST.*\s+(413|500|503)</regex>
    <description>Large POST request causing server error - POST flood</description>
    <mitre>
      <id>T1499</id>
    </mitre>
    <group>dos,apache,post_flood,</group>
  </rule>

  <!-- ====== APT INDICATORS ====== -->
  <rule id="100300" level="8" frequency="10" timeframe="30">
    <if_matched_sid>30101,30102,30103</if_matched_sid>
    <same_source_ip />
    <description>Multiple 404 errors - Directory/vulnerability scanning</description>
    <mitre>
      <id>T1595</id>
      <id>T1083</id>
    </mitre>
    <group>apt,recon,apache,</group>
  </rule>

  <rule id="100301" level="10">
    <if_sid>30100,30101,30102,30103</if_sid>
    <regex type="pcre2">(phpMyAdmin|phpmyadmin|wp-admin|wp-login|admin|administrator|cgi-bin|shell|webshell)</regex>
    <description>APT recon - Scanning for vulnerable web applications</description>
    <mitre>
      <id>T1595.002</id>
    </mitre>
    <group>apt,recon,apache,</group>
  </rule>

  <rule id="100302" level="12">
    <if_sid>31100</if_sid>
    <regex type="pcre2">(\%27)|(\-\-)|(\%23)|(UNION.*SELECT)|(SELECT.*FROM)|(INSERT.*INTO)|(DELETE.*FROM)|(DROP.*TABLE)|(;.*DROP)|(OR.*1=1)|(AND.*1=1)|('.*OR.*'.*=.*')</regex>
    <description>SQL injection attempt - APT technique</description>
    <mitre>
      <id>T1190</id>
      <id>T1059.007</id>
    </mitre>
    <group>apt,sqli,apache,web,accesslog,</group>
  </rule>

  <rule id="100303" level="10">
    <if_sid>30100</if_sid>
    <regex type="pcre2">(&lt;script|javascript:|onerror=|onload=|eval\(|alert\()</regex>
    <description>Cross-Site Scripting (XSS) attempt - APT technique</description>
    <mitre>
      <id>T1059.007</id>
    </mitre>
    <group>apt,xss,apache,</group>
  </rule>

  <rule id="100304" level="12">
    <if_sid>30100</if_sid>
    <regex type="pcre2">(\||;|`|&amp;)(cat|ls|id|whoami|uname|wget|curl|nc|netcat|bash|sh|python|perl|php)</regex>
    <description>Command injection attempt detected</description>
    <mitre>
      <id>T1190</id>
      <id>T1059</id>
    </mitre>
    <group>apt,command_injection,apache,</group>
  </rule>

  <rule id="100305" level="10">
    <if_sid>30100</if_sid>
    <regex type="pcre2">(\.\./|\.\.\\|/etc/passwd|/etc/shadow|windows/system32|boot\.ini)</regex>
    <description>Path traversal / Local File Inclusion attempt</description>
    <mitre>
      <id>T1083</id>
      <id>T1005</id>
    </mitre>
    <group>apt,lfi,apache,</group>
  </rule>

  <rule id="100306" level="14">
    <if_sid>30100</if_sid>
    <match>POST</match>
    <regex type="pcre2">(c99|r57|b374k|webshell|cmd\.php|shell\.php|backdoor)</regex>
    <description>Web shell upload attempt - APT persistence mechanism</description>
    <mitre>
      <id>T1505.003</id>
      <id>T1027</id>
    </mitre>
    <group>apt,webshell,apache,</group>
  </rule>

  <rule id="100307" level="10">
    <if_sid>30100</if_sid>
    <regex type="pcre2">(base64|eval|fromCharCode|atob|exec)</regex>
    <match>POST</match>
    <description>Encoded payload detected - Obfuscated APT attack</description>
    <mitre>
      <id>T1027</id>
      <id>T1140</id>
    </mitre>
    <group>apt,obfuscation,apache,</group>
  </rule>

  <rule id="100308" level="12" frequency="5" timeframe="3600">
    <if_matched_sid>100301,100302,100303,100304,100305</if_matched_sid>
    <same_source_ip />
    <description>Repeated malicious activity - APT persistence behavior</description>
    <mitre>
      <id>T1071</id>
    </mitre>
    <group>apt,persistence,apache,</group>
  </rule>

  <rule id="100309" level="10">
    <if_sid>30100</if_sid>
    <match>200</match>
    <regex type="pcre2">\s+200\s+\d{7,}</regex>
    <description>Large HTTP response (>1MB) - Possible data exfiltration</description>
    <mitre>
      <id>T1041</id>
    </mitre>
    <group>apt,exfiltration,apache,</group>
  </rule>

  <rule id="100310" level="8">
    <if_sid>30100</if_sid>
    <regex type="pcre2">(nikto|nmap|masscan|sqlmap|metasploit|havij|acunetix|nessus|openvas|burp|zaproxy|dirbuster)</regex>
    <description>Security scanner/attack tool detected in User-Agent</description>
    <mitre>
      <id>T1595</id>
    </mitre>
    <group>apt,recon,scanner,apache,</group>
  </rule>

  <rule id="100311" level="10" frequency="5" timeframe="60">
    <if_matched_sid>30105</if_matched_sid>
    <same_source_ip />
    <description>Multiple authentication failures - Brute force attack</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>apt,bruteforce,apache,</group>
  </rule>

  <rule id="100312" level="12">
    <if_sid>30100</if_sid>
    <regex type="pcre2">(\.bak|\.backup|\.old|\.sql|\.conf|\.config|\.env|\.git|\.svn|web\.config|\.htaccess|\.htpasswd)</regex>
    <description>Attempt to access sensitive backup/configuration files</description>
    <mitre>
      <id>T1552</id>
      <id>T1083</id>
    </mitre>
    <group>apt,credential_access,apache,</group>
  </rule>

</group>
