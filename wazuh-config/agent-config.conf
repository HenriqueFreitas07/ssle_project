<ossec_config>
  <!-- ===== GLOBAL / AGENT TUNING ===== -->
  <global>
    <!-- Increase agent-side queue and throughput -->
    <queue_size>262144</queue_size>
    <logall>no</logall>
    <logall_json>no</logall_json>
    <alerts_log>yes</alerts_log>
    <jsonout_output>yes</jsonout_output>

    <!-- Active-response: accept manager commands -->
    <white_list>127.0.0.1</white_list>
    <white_list>^localhost.localdomain$</white_list>
  </global>

  <!-- ===== CLIENT (CONNECTION TO MANAGER) ===== -->
  <client>
    <server>
      <address>MANAGER_ADDRESS</address>
      <port>1514</port>
      <protocol>tcp</protocol>
    </server>
  </client>

  <!-- ===== LOGGING / FILE MONITORS ===== -->
  <localfile>
    <log_format>apache</log_format>
    <location>/var/log/apache2/access.log</location>
  </localfile>

  <localfile>
    <log_format>apache</log_format>
    <location>/var/log/apache2/error.log</location>
  </localfile>

  <!-- Monitor Apache ModSecurity logs for WAF events -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/apache2/modsec_audit.log</location>
  </localfile>

  <!-- Monitor for any additional Apache logs -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/apache2/other_vhosts_access.log</location>
  </localfile>

  <!-- Periodically collect Apache connection statistics -->
  <localfile>
    <log_format>full_command</log_format>
    <command>netstat -ant | grep ':80 ' | wc -l</command>
    <frequency>5</frequency>
  </localfile>

  <!-- Monitor Apache process count (detect DoS impact) -->
  <localfile>
    <log_format>full_command</log_format>
    <command>ps aux | grep apache2 | grep -v grep | wc -l</command>
    <frequency>10</frequency>
  </localfile>

  <!-- Monitor Apache server status if mod_status is enabled -->
  <localfile>
    <log_format>full_command</log_format>
    <command>curl -s http://localhost/server-status 2>/dev/null | grep -E 'requests currently|requests/sec' || echo 'server-status unavailable'</command>
    <frequency>30</frequency>
  </localfile>

  <!-- Last logins / sessions -->
  <localfile>
    <log_format>full_command</log_format>
    <command>last -n 20</command>
    <frequency>360</frequency>
  </localfile>

  <!-- ===== SYSCHECK (FIM) TUNING ===== -->
  <syscheck>
    <disabled>no</disabled>
    <frequency>86400</frequency>
    <scan_on_start>no</scan_on_start>
    <alert_new_files>yes</alert_new_files>

    <!-- Monitor critical Apache directories for APT persistence (web shells, backdoors) -->
    <directories check_all="yes" realtime="yes" report_changes="yes">/var/www/html</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/usr/lib/cgi-bin</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/apache2</directories>

    <!-- Ignore common temporary files but alert on suspicious extensions -->
    <ignore type="sregex">\.swp$|\.tmp$</ignore>

    <!-- Skip proc/sys areas that are noisy in containers -->
    <skip_nfs>yes</skip_nfs>
    <skip_dev>yes</skip_dev>
    <skip_proc>yes</skip_proc>
    <skip_sys>yes</skip_sys>

    <process_priority>10</process_priority>

    <synchronization>
      <enabled>yes</enabled>
      <interval>5m</interval>
      <max_eps>500</max_eps>
    </synchronization>
  </syscheck>

  <!-- ===== MODULES: disable heavy modules during DoS testing to free CPU ===== -->
  <wodle name="syscollector">
    <disabled>yes</disabled>
  </wodle>

  <wodle name="osquery">
    <disabled>yes</disabled>
  </wodle>

  <rootcheck>
    <disabled>yes</disabled>
  </rootcheck>

  <sca>
    <enabled>no</enabled>
  </sca>

  <!-- ===== ACTIVE RESPONSE ===== -->
  <active-response>
    <disabled>no</disabled>
  </active-response>

  <!-- ===== MONITORING / LOGS HELPERS ===== -->
  <localfile>
    <log_format>command</log_format>
    <command>df -P</command>
    <frequency>300</frequency>
  </localfile>

  <!-- Keep journald watching for container system events -->
  <localfile>
    <log_format>journald</log_format>
    <location>journald</location>
  </localfile>

</ossec_config>
